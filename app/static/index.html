<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>SHAKEMAP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin />
  
  <link rel="stylesheet" href="/static/style.css?v=1">
</head>
<body>
  <div class="controls">
    <div class="controls-row">
      <div class="searchbox">
        <input id="searchInput" type="text" placeholder="ค้นหาสถานที่" autocomplete="off" />
        <button id="searchBtn" title="ค้นหา">ค้นหา</button>
        <ul id="acList" class="ac"></ul>
      </div>

     <!-- ปุ่มตำแหน่งของฉัน -->
<button id="locateBtn" class="icon-btn" title="ตำแหน่งของฉัน" aria-label="ตำแหน่งของฉัน">
  <!-- เปลี่ยนเป็นไอคอนคน -->
  <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
    <path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/>
  </svg>
</button>


      <!-- ปุ่มเหตุการณ์ล่าสุด -->
      <!-- โหลด Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<!-- ปุ่มเหตุการณ์ล่าสุด -->
<button id="runBtn" class="icon-btn" title="เหตุการณ์แผ่นดินไหว" aria-label="เหตุการณ์ล่าสุด">
  <i class="fa-solid fa-house-crack"></i>
</button>


    </div>
  </div>

  <div id="map"></div>
  <div id="toast" class="toast" style="display:none"></div>


  <!-- PGA Legend -->
  <div id="legend" class="legend" style="display:none">
    <div class="legend-title">PGA (%g)</div>
    <div class="legend-bar"></div>
    <div class="legend-labels"></div>
  </div>



  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin></script>

  <script>
    
    /* ---------------- Helpers ---------------- */
    function toast(msg, isError=false){
      const t = document.getElementById('toast');
      t.textContent = msg || '';
      t.classList.toggle('error', !!isError);
      t.style.display = msg ? 'block' : 'none';
      if(msg){ clearTimeout(toast._tmr); toast._tmr = setTimeout(()=>t.style.display='none', 4000); }
    }
    function _esc(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    /* ---------------- Map base ---------------- */
    const osm  = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'&copy; OpenStreetMap' });
    const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{ maxZoom:19, attribution:'Tiles &copy; Esri' });
    const baseLayers = { "OpenStreetMap": osm, "Esri World Imagery": esri };

    const pgaImageGroup  = L.layerGroup();
    const epicenterGroup = L.layerGroup();
    const legendLayer = L.layerGroup();   // << สำหรับ toggle legend

    const map = L.map('map', { 
      center:[15,100],
      zoom:6, layers:[osm, 
      pgaImageGroup, 
      epicenterGroup] 
      }
    );

    const layerControl = L.control.layers(
      baseLayers,
      {
        'PGA (Interpolation)': pgaImageGroup,
        'PGA Scale Bar': legendLayer           
      }
    ).addTo(map);

    
    layerControl.setPosition('bottomright');
    layerControl.addTo(map);
    map.zoomControl.setPosition('bottomright');
    /* ---------------- State ---------------- */
    let overlayLayer = null;
    let epicenterMarker = null;
    let searchMarker = null;
    let userDistanceLine = null;
    let lastPGAData = null;
    let lastPGAGrid = [];
    let lastEpicenter = null;

    /* ---------------- Icons ---------------- */
    const blueIcon = L.icon({
      iconUrl:'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-blue.png',
      iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
    });
    const redIcon = L.icon({
      iconUrl:'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-red.png',
      iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
    });

    /* ---------------- PGA Compute ---------------- */
    function resetLatest(){
      if (overlayLayer && pgaImageGroup.hasLayer(overlayLayer)) pgaImageGroup.removeLayer(overlayLayer);
      overlayLayer = null;

      if (epicenterMarker && epicenterGroup.hasLayer(epicenterMarker)) epicenterGroup.removeLayer(epicenterMarker);
      epicenterMarker = null;

      if (userDistanceLine && map.hasLayer(userDistanceLine)) map.removeLayer(userDistanceLine);
      userDistanceLine = null;

      lastPGAData = null; lastPGAGrid = []; lastEpicenter = null;
            lastPGAData = null; lastPGAGrid = []; lastEpicenter = null;

      // ซ่อน legend เมื่อยังไม่มีข้อมูล
      const lg = document.getElementById('legend');
      if (lg) lg.style.display = 'none';
      setLegendVisible(false);
      if (map.hasLayer(legendLayer)) map.removeLayer(legendLayer);
    }


    let _btnTmr = null, _btnStart = 0;
    function setRunBtnTimer(running){
      const btn = document.getElementById('runBtn');
      if(running){
        _btnStart = Date.now();
        btn.disabled = true;
        _btnTmr = setInterval(()=>{
        const s = Math.floor((Date.now() - _btnStart) / 1000);
        const mm = String(Math.floor(s/60)).padStart(2,'0');
        const ss = String(s%60).padStart(2,'0');
        btn.textContent = `${mm}:${ss}`;   // <<=== แสดงตัวเลขเวลาอย่างเดียว
    }, 200);
  }else{
      if(_btnTmr){ clearInterval(_btnTmr); _btnTmr = null; }
      btn.disabled = false;
      // กลับเป็นไอคอนเหตุการณ์
      btn.innerHTML = `<i class="fa-solid fa-house-crack" aria-hidden="true"></i>`;
    }
  }


  async function runCompute(){
  setRunBtnTimer(true);   // เริ่มจับเวลา
  toast('กำลังดึงข้อมูลล่าสุดจาก TMD และคำนวณ PGA ...');
  try{
    resetLatest();
    const res = await fetch('/api/run', { method:'POST' });
    if(!res.ok) throw new Error((await res.text()) || ('HTTP '+res.status));
    const data = await res.json();

          // ... วาง overlay, marker แล้ว ...
    renderLegend(data.legend);
      if (!map.hasLayer(legendLayer)) legendLayer.addTo(map);
        setLegendVisible(true);


    if(data.error) throw new Error(data.error);

      const { bounds, epicenter, image_data_url, popup_html, meta, pga_points } = data;
      lastPGAGrid = Array.isArray(pga_points) ? pga_points : [];

      overlayLayer = L.imageOverlay(image_data_url, bounds, { opacity:0.75 });
      pgaImageGroup.addLayer(overlayLayer);

      epicenterMarker = L.marker(epicenter, { title:'Epicenter', icon:redIcon });
      if (popup_html) epicenterMarker.bindPopup(popup_html, { maxWidth:320, autoPan:true });
      epicenterGroup.addLayer(epicenterMarker);
      if (popup_html) epicenterMarker.openPopup();

      map.fitBounds(bounds, { padding:[20,20] });
      lastEpicenter = epicenter;
      lastPGAData  = { bounds, epicenter, image_data_url, popup_html, meta };
      toast(`สำเร็จ: เวลา ${meta?.time_th || '-'}, Mag ${meta?.mag ?? '-'}, ${meta?.changwat || '-'}`);
      updateUserMarkerPopup(); drawUserDistanceLine();
    }catch(err){
    console.error(err);
    toast('เกิดข้อผิดพลาด: '+(err.message||err), true);
    }finally{
    setRunBtnTimer(false);  // หยุดจับเวลา กลับเป็น "เหตุการณ์ล่าสุด"
    
  
      }
    }

    /* ---------------- Utilities ---------------- */
    function calcDistanceKm(lat1, lon1, lat2, lon2){
      const R=6371, toRad=x=>x*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function classifySeverity(pga){
      if (pga === 0) return { label:"ไม่มีผลกระทบ", className:"sev-none" };
      if (pga <= 3.6) return { label:"ระดับต่ำ",  className:"sev-low" };
      if (pga <= 9.6) return { label:"ระดับกลาง", className:"sev-mid" };
      return { label:"ระดับสูง", className:"sev-high" };
    }

    function findNearestPGA(lat, lon, limitKm=8){
      if (!lastPGAGrid.length) return null;
      const toRad = d=>d*Math.PI/180, R=6371;
      let best=null, bestD=Infinity;
      for(const p of lastPGAGrid){
        const dLat = toRad(p.lat-lat), dLon = toRad(p.lon-lon);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat))*Math.cos(toRad(p.lat))*Math.sin(dLon/2)**2;
        const d = 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        if (d < bestD) { bestD = d; best = p; }
      }
      return (best && bestD <= limitKm) ? {...best, dist:bestD} : null;
    }

    function updateUserMarkerPopup(){
      if (!searchMarker) return;
      const latlng = searchMarker.getLatLng();
      let popup = searchMarker.options.title || '';
      if (lastEpicenter && latlng){
        const dist = calcDistanceKm(latlng.lat, latlng.lng, lastEpicenter[0], lastEpicenter[1]);
        popup += `<br><span>ระยะห่างจากจุดศูนย์กลาง : <b>${dist.toFixed(2)}</b> กม.</span>`;
        if (lastPGAGrid.length){
          const pgaObj = findNearestPGA(latlng.lat, latlng.lng, 8);
          const pgaVal = (pgaObj && pgaObj.pga>0) ? pgaObj.pga : 0;
          const sev = classifySeverity(pgaVal);
          popup += `<br><span>ค่าระดับการสั่นสะเทือน : <b class="${sev.className}">${pgaVal.toFixed(3)}</b> %g</span>`;
          popup += `<br><span class="${sev.className}">ระดับความรุนแรง : ${sev.label}</span>`;
        }
      }
      searchMarker.getPopup()?.setContent(popup);
    }

    function drawUserDistanceLine(){
      if (userDistanceLine) { map.removeLayer(userDistanceLine); userDistanceLine=null; }
      if (!searchMarker || !lastEpicenter) return;
      const u = searchMarker.getLatLng();
      userDistanceLine = L.polyline([ [u.lat,u.lng], [lastEpicenter[0],lastEpicenter[1]] ],
        { color:"#ff0080", weight:3, dashArray:"8 8", opacity:.95, lineCap:"round", zIndex:9999 }).addTo(map);
    }

    /* ---------------- Search & Autocomplete ---------------- */
    const acList = document.getElementById('acList');
    const searchInput = document.getElementById('searchInput');
    let acResults = []; let acSelected = -1;

    const debounce = (fn, wait=350)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; };
    const debouncedSearch = debounce(() => doSearch(searchInput.value.trim()), 350);
    const showAC = show => acList.style.display = (show && acResults.length) ? 'block' : 'none';

    async function queryNominatim(q, limit = 6) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&accept-language=th&limit=${limit}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Nominatim error ' + res.status);
      return await res.json();
    }
    async function queryPhoton(q, limit = 6) {
      const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(q)}&lang=th&limit=${limit}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Photon error ' + res.status);
      const data = await res.json();
      return (data.features || []).map(f => ({
        lat: f.geometry.coordinates[1],
        lon: f.geometry.coordinates[0],
        display_name: f.properties.name
          ? `${f.properties.name}${f.properties.city ? ', '+f.properties.city : ''}${f.properties.country ? ', '+f.properties.country : ''}`
          : (f.properties.city || f.properties.country || '')
      }));
    }

    async function doSearch(q){
      if (!q) { showAC(false); return; }
      try {
        toast('ค้นหา "' + q + '" ...');
        let results = [];
        try { results = await queryNominatim(q, 8); }
        catch(e) { results = await queryPhoton(q, 8); }
        acResults = results; acSelected = -1;
        acList.innerHTML = results.map((it, idx) => {
          const display = it.display_name || it.name || '';
          const parts = display.split(',');
          const main = _esc((parts[0] || '').trim() || '(ไม่ทราบชื่อ)');
          const sub = _esc(parts.slice(1).join(',').trim());
          return `<li data-idx="${idx}"><span class="ac-main">${main}</span><span class="ac-sub">${sub ? ', '+sub : ''}</span></li>`;
        }).join('');
        showAC(true);
      } catch (e) {
        console.error(e);
        toast('ค้นหาล้มเหลว: ' + (e.message || e), true);
        showAC(false);
      }
    }

    function updateACActive() {
      Array.from(acList.children).forEach((li, i) => li.classList.toggle('active', i === acSelected));
    }
    function selectAC(idx) {
      const it = acResults[idx]; if (!it) return;
      showAC(false); acResults = []; acSelected = -1; searchInput.value = '';
      const lat = parseFloat(it.lat), lon = parseFloat(it.lon);
      const display = it.display_name || '';
      if (searchMarker) map.removeLayer(searchMarker);
      searchMarker = L.marker([lat, lon], { title: display, icon: blueIcon }).addTo(map);
      searchMarker.bindPopup(display, { maxWidth: 320, autoPan: true }).openPopup();
      map.setView([lat, lon], 12);
      toast('ค้นหาสำเร็จ: ' + (display || `(${lat.toFixed(5)}, ${lon.toFixed(5)})`));
      updateUserMarkerPopup(); drawUserDistanceLine();
    }

    document.getElementById('searchBtn').addEventListener('click', () => {
      const q = searchInput.value.trim(); if (!q) return;
      doSearch(q).then(() => { if (acResults.length) selectAC(0); });
    });
    searchInput.addEventListener('input', () => { if (searchInput.value.trim()) debouncedSearch(); else showAC(false); });
    searchInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (acSelected >= 0) selectAC(acSelected);
        else if (acResults.length) selectAC(0);
        else doSearch(searchInput.value.trim()).then(()=>{ if (acResults.length) selectAC(0); });
      } else if (e.key === 'ArrowDown') {
        if (acResults.length) { acSelected = Math.min(acSelected + 1, acResults.length - 1); updateACActive(); showAC(true); }
        e.preventDefault();
      } else if (e.key === 'ArrowUp') {
        if (acResults.length) { acSelected = Math.max(acSelected - 1, 0); updateACActive(); showAC(true); }
        e.preventDefault();
      } else if (e.key === 'Escape') {
        showAC(false);
      }
    });
    acList.addEventListener('mousedown', e => {
      let li = e.target; while (li && li.tagName !== 'LI') li = li.parentElement;
      if (li) selectAC(+li.getAttribute('data-idx'));
    });
    document.addEventListener('mousedown', e => { if (!acList.contains(e.target) && e.target !== searchInput) showAC(false); });

    /* ---------------- Locate & Map Click ---------------- */
    let locateCooldown = false;
    async function locateMe(){
      if (locateCooldown) return; locateCooldown=true; setTimeout(()=>locateCooldown=false, 2000);
      toast('กำลังค้นหาตำแหน่งของคุณ...');
      if (!navigator.geolocation) return toast('เบราว์เซอร์ไม่รองรับการหาตำแหน่ง', true);
      navigator.geolocation.getCurrentPosition(async pos=>{
        const { latitude, longitude } = pos.coords;
        try{
          const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}&accept-language=th&zoom=12&addressdetails=1`;
          const res = await fetch(url);
          const data = await res.json();
          const display = data.display_name || 'ตำแหน่งของฉัน';
          if (searchMarker) map.removeLayer(searchMarker);
          searchMarker = L.marker([latitude,longitude], { title: display, icon: blueIcon }).addTo(map);
          searchMarker.bindPopup(display, { maxWidth:320, autoPan:true }).openPopup();
          map.setView([latitude, longitude], 13);
          toast('แสดงตำแหน่งของคุณแล้ว');
          updateUserMarkerPopup(); drawUserDistanceLine();
        }catch(err){ toast('ไม่สามารถค้นหาชื่อสถานที่: '+(err.message||err), true); }
      }, err=>toast('ไม่สามารถหาตำแหน่ง: '+err.message, true));
    }
    document.getElementById('locateBtn').addEventListener('click', locateMe);

    map.on('click', async e=>{
      const { lat, lng } = e.latlng;
      toast('กำลังค้นหาชื่อสถานที่...');
      try{
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&accept-language=th&zoom=12&addressdetails=1`;
        const res = await fetch(url);
        const data = await res.json();
        const display = data.display_name || `(${lat.toFixed(5)}, ${lng.toFixed(5)})`;
        if (searchMarker) map.removeLayer(searchMarker);
        searchMarker = L.marker([lat,lng], { title: display, icon: blueIcon }).addTo(map);
        searchMarker.bindPopup(display, { maxWidth:320, autoPan:true }).openPopup();
        toast('เลือกตำแหน่งแล้ว');
        updateUserMarkerPopup(); drawUserDistanceLine();
      }catch(err){ toast('ไม่สามารถค้นหาชื่อสถานที่: '+(err.message||err), true); }
    });

    map.on('popupopen', (e)=>{ if (searchMarker && e.popup === searchMarker.getPopup()) updateUserMarkerPopup(); });

    function updatePGAVisibility(){
      const has = map.hasLayer(pgaImageGroup);
      if (!has){
        if (overlayLayer) pgaImageGroup.removeLayer(overlayLayer), overlayLayer=null;
      }else{
        if (!overlayLayer && lastPGAData){
          overlayLayer = L.imageOverlay(lastPGAData.image_data_url, lastPGAData.bounds, { opacity:.75 });
          pgaImageGroup.addLayer(overlayLayer);
        }
      }
    }
    map.on('overlayadd overlayremove', e=>{ if (e.layer === pgaImageGroup) updatePGAVisibility(); });

    document.getElementById('runBtn').addEventListener('click', runCompute);


    function setLegendVisible(show){
      const box = document.getElementById('legend');
      box.style.display = show ? 'block' : 'none';
    }

    // ซิงก์สถานะ checkbox ของ Legend กับ DOM จริง
    map.on('overlayadd',   e => { if (e.layer === legendLayer) setLegendVisible(true);  });
    map.on('overlayremove',e => { if (e.layer === legendLayer) setLegendVisible(false); });


    function renderLegend(legend){
      const box = document.getElementById('legend');
      if(!legend || !legend.stops || !legend.stops.length){
        box.style.display = 'none';
        return;
      }
      const bar = box.querySelector('.legend-bar');
      const labels = box.querySelector('.legend-labels');
      const title = box.querySelector('.legend-title');

      title.textContent = `PGA (${legend.units||'%g'})`;

      // linear-gradient ตามสีจาก backend
      const grad = legend.stops.map((s,i)=>{
        const pct = (i/(legend.stops.length-1))*100;
        return `${s.color} ${pct}%`;
      }).join(', ');
      bar.style.background = `linear-gradient(to right, ${grad})`;

      // ป้ายตัวเลข: ซ้าย-กลาง-ขวา (อ่านง่าย ไม่รก)
      const mid = (legend.min + legend.max)/2;
      labels.innerHTML = `
        <span>${legend.min.toFixed(3)}</span>
        <span>${mid.toFixed(3)}</span>
        <span>${legend.max.toFixed(3)}</span>
      `;

      box.style.display = 'block';
    }

  </script>
</body>
</html>
